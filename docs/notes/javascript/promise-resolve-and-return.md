---
title: Promise ä¸­ resolve å’Œ return
date: 2021-06-13 12:03:27
tags:
  - Promise
---

## èƒŒæ™¯

æœ€è¿‘é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå…·ä½“çš„åœºæ™¯æ˜¯ï¼Œæ¥å£ `A` è¿”å›ä¸€æ®µå¯ä»¥è®©å‰ç«¯æ¸²æŸ“çš„ `html` å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²é‡ŒåŒ…å«é‡Œä¸€ä¸ªå¯æ’­æ”¾çš„ `video` çš„åœ°å€ï¼Œä½†æ˜¯åœ°å€æ˜¯ä¸å¯æ’­æ”¾çš„ï¼Œéœ€è¦æ›¿æ¢ä¸ºå¦å¤–ä¸€ä¸ªå¯æ’­æ”¾çš„åŸŸåã€‚

## å¤„ç†æµç¨‹

è§£å†³æ–¹å¼ï¼šå…ˆè¯·æ±‚æ¥å£ `A` è·å– `html` å­—ç¬¦ä¸²ï¼Œä»ä¸­æˆªå– `video` çš„ `src` å±æ€§ï¼Œå†è°ƒæ¥å£ `B` å°†æ¥å£è½¬æ¢ä¸ºå¯æ’­æ”¾çš„ `url`ï¼Œæœ€åæ‹¿åˆ°æ–°çš„ `url` ä¹‹åå†é€šè¿‡æ­£åˆ™çš„ `replace` æ–¹æ³•å°†å¯¹åº”çš„ `url` æ›¿æ¢æˆæ–°çš„ `url`ï¼Œç„¶åå†å¤„ç†å‰©ä¸‹çš„é€»è¾‘ã€‚

å…¶å®æ‹ä¸‹æ¥ä¹‹åå‘ç°æ— éå°±æ˜¯ `A` çš„å›è°ƒç»“æœé‡Œè°ƒ `B` æ¥å£ï¼Œä½†æ˜¯å³ä¾¿æ˜¯åµŒå¥—ä¸€å±‚ï¼Œä¹Ÿä¸å¤Ÿä¼˜é›…ï¼Œäºæ˜¯åœ¨æƒ³åˆ©ç”¨ `Promise` çš„ä¸²è¡Œå¤„ç†ï¼Œå°†å›è°ƒæ‰“å¹³ï¼Œ`Promise` çš„å¤„ç†æ— éä¹Ÿå°±æ˜¯å…ˆå»è°ƒç”¨ `A` æ¥å£ï¼Œè·å–æ•°æ®ä¹‹åå°†ç»“æœä¼ é€’å‡ºå»å†é€šè¿‡`.then` æ‹¿åˆ°è¿”å›å€¼æ•°æ®ï¼Œåœ¨`.then` é‡Œå†è°ƒæ–°æ¥å£ `B` ä»è€Œè§£å†³é—®é¢˜ã€‚è™½ç„¶åæ¥ç¡®å®é€šè¿‡ `Promise` çš„é“¾å¼è°ƒç”¨è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿæœ‰ä¸€äº›ç–‘æƒ‘ï¼Œå°±æ˜¯å¦‚é¢˜ã€‚

## æ‹†è§£å’Œç†è§£

æ ¹æ® `es6` çš„ `resolve` çš„ç†è§£ï¼Œå…¶å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°† `Promise` å¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œæˆåŠŸâ€ï¼ˆå³ä» `pending` å˜ä¸º `resolved`ï¼‰ï¼Œåœ¨å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»ï¼Œå¦‚æœæˆ‘ä»¬ä¸ `resolve`ï¼Œåˆ™æ•°æ®ä¸€ç›´è¢«ä¿å­˜åœ¨ä¸Šä¸€ä¸ª `Promise` çš„å‡½æ•°ä¸­ã€‚ç»è¿‡æ•´ç†é‡æ–°å­¦ä¹ åå‘ç°ï¼Œå¦‚æœéœ€è¦å°† `Promise` çš„è¿”å›çš„ç»“æœåœ¨å½“å‰å‡½æ•°çš„`.then` é‡Œä¸€ç›´æŒ‰ç…§æ¬¡åºå¾€ä¸‹ä¼ é€’ï¼Œå…¶æ˜¯å¿…é¡»è¦åœ¨ä¸Šä¸€æ­¥çš„ `then` é‡Œå°†ç»“æœ `return` æ‰èƒ½åœ¨ä¸‹ä¸€ä¸ª `then` é‡Œæ¥ä½ï¼Œä¸€æ—¦åœ¨æŸä¸€ä¸ª `then` é‡Œ `resolve` äº†ï¼Œåˆ™åœ¨ `resolve` çš„é‚£ä¸ª `then` åé¢çš„ `then` ä¸­è™½ç„¶åé¢çš„é€»è¾‘ä¼šæ‰§è¡Œï¼Œä½†æ˜¯è·å–ä¸åˆ°ä¸Šä¸€æ¬¡è®¡ç®—çš„ç»“æœï¼Œåè€Œæ˜¯ç›´æ¥åœ¨ `resolve` çš„ `then` é‡Œå°†ç»“æœä»å½“å‰å‡½æ•°ä¼ é€’å‡ºå»äº†ã€‚

## ç¤ºä¾‹

å…·ä½“ç”¨ä¸€ä¸ª ğŸŒ° æ¥çœ‹ï¼š
å‡è®¾ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª `sleep` çš„ `Promise` çš„æ¨¡æ‹Ÿå¼‚æ­¥æ–¹æ³•ï¼Œä¼ é€’ä¸åŒçš„ `ms` æ•°ä»£è¡¨åˆ†åˆ«ä»£è¡¨ `Aã€B` ä¿©æ¥å£ã€‚

```js
var sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

// è¿™æ˜¯è·å–æ–°urlçš„æ¥å£B
var urlConvert = (url) =>
  new Promise((resolve, reject) => {
    console.log(`æˆ‘ä»¬ç°åœ¨è·å–åˆ°äº†æ—§çš„url:${url} è¦å»è¯·æ±‚æ–°çš„`);
    sleep(500).then((res) => {
      if (true) {
        resolve("http//newVideoUrl.com");
      } else {
        reject("å‘ç”Ÿé”™è¯¯");
      }
    });
  });

var handleData = () =>
  new Promise((resolve, reject) => {
    // æ¥å£A
    var initUrl = sleep(1000).then((res) => "http://oldVideoUrl.com");

    initUrl.then((res) => urlConvert(res)).then((res) => resolve(res));
  });

handleData().then((url) => {
  console.log("url", url);
});
```

è¿™é‡Œæˆ‘ä»¬èƒ½å‘ç°åœ¨ `handleData` å†…éƒ¨ï¼Œæˆ‘æ˜¯éœ€è¦å…ˆå¤„ç†å®Œæ•°æ®ï¼Œåœ¨æœ€åæ‰å°†å¤„ç†å®Œçš„æ•°æ® `resolve`ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°æ˜¯å‰è¾¹é€šè¿‡ç®­å¤´å‡½æ•°ä¸€æ­¥ä¸€æ­¥å°†ä¸Šä¸€æ¬¡å¤„ç†çš„ç»“æœ `return` äº†ï¼Œæ‰€ä»¥åœ¨ä¸‹ä¸€ä¸ª `then` é‡Œæ‰è·å–åˆ°å¤„ç†å®Œæˆçš„æ•°æ®ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨æœ€åä¸€æ­¥é€šè¿‡ `resolve` å°†ç»“æœè¿”å›ï¼Œå½“æˆ‘ä»¬åœ¨å¤–éƒ¨è°ƒç”¨ `handleData` ä¹‹åï¼Œé“¾å¼è°ƒç”¨çš„ç»“æœæ˜¯å¯ä»¥è·å–åˆ° `url` çš„å€¼ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†æœ€åä¸€æ­¥ç»“æœä¾æ—§æ”¹æˆ `return` çš„å½¢å¼ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ•ˆæœã€‚

```diff
- initUrl.then((res) => urlConvert(res)).then((res) => resolve(res));
+ initUrl.then((res) => urlConvert(res)).then((res) => res);

handleData().then((url) => {
  console.log("url", url);
});
```

å†æ¬¡è¿è¡Œåï¼Œå‘ç°æ²¡æœ‰æ‰“å°ä¹Ÿå°±æ˜¯æ²¡èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜å¦‚æœç›´æ¥ `return` çš„è¯æ˜¯æ— æ³•ä»åŸæ¥çš„å‡½æ•°é‡Œå°† `Promise` çš„ç»“æœä¼ é€’å‡ºå»çš„ã€‚

## ç»“è®º

è¿™é‡ŒåŸºæœ¬ä¸Šæ˜¯æ›´æ¸…æ¥šäº†ï¼Œå¦‚æœä¸éœ€è¦å°†ç»“æœä¼ é€’å‡ºå»ï¼Œåœ¨ `then` å¤„ç†å®Œæˆä¹‹å `return value` å°±å¥½äº†ï¼Œå¦‚æœéœ€è¦ä¼ é€’å‡ºå»å°±å°†æ•°æ® `resolve(value)` å‡ºå»ï¼Œè‡³äº `resolve` çš„æ—¶å€™è¦ä¸è¦ åŠ  `return` å°±çœ‹è¿˜è¦ä¸è¦å¤„ç† `resolve` åé¢çš„é€»è¾‘ï¼Œä¸€èˆ¬æ¥è¯´ç«‹å³ `resolved` çš„ `Promise` æ˜¯åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯çš„æœ«å°¾æ‰§è¡Œï¼Œæ€»æ˜¯æ™šäºæœ¬è½®å¾ªç¯çš„åŒæ­¥ä»»åŠ¡ã€‚

æ‰€ä»¥å¦‚æœä¸Šè¿°ä¾‹å­æ”¹ä¸º

```diff
- initUrl.then((res) => urlConvert(res)).then((res) => resolve(res));
+ initUrl.then((res) => urlConvert(res)).then((res) => {
+  resolve(res)
+  console.log('resolveåï¼Œæ‰“å°urlå‰')
+});
```

ä¾¿ä¼šåœ¨ `resolve` çš„é‚£æ¬¡äº‹ä»¶å¾ªç¯åï¼Œå¹¶ä¸”ä¼šåœ¨æ–°çš„ä¸€è½® `handleData()` å‰æ‰§è¡Œã€‚
