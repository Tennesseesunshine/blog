---
title: EventBus
date: 2021-01-14 22:54:22
tags: Vue
---

ç®€å•å®ç°ä¸€ä¸ª vue ä¸­çš„ `EventBus`ï¼Œé¦–å…ˆåˆ†æä¸€ä¸‹ `vue` ä¸­çš„ä¸€äº›ç”¨æ³•

## æ³¨å†Œ

- `this.$on('eventName', (...params) => {})`

å…¶å®æˆ‘ä»¬åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¯ä»¥å‘ç°ï¼Œ`$on`çš„äº‹ä»¶å¯ä»¥æ³¨å†Œå¤šæ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥åœ¨å¾ˆå¤šç»„ä»¶é‡Œè¿›è¡Œä¸€ä¸ªäº‹ä»¶çš„æ³¨å†Œï¼Œåœ¨`$emit` è§¦å‘ç›¸åº”çš„äº‹ä»¶çš„æ—¶å€™ï¼Œå¯¹åº”æ³¨å†Œçš„æ‰€æœ‰äº‹ä»¶éƒ½ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½æƒ³åˆ°å®ƒçš„å®ç°ä¸€å®šæ˜¯ï¼Œå¦‚æœåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œæ³¨å†Œäº†ç›¸åŒçš„äº‹ä»¶ï¼Œä¼šä¸€ç›´å¾€å½“å‰çš„è¿™ä¸ªäº‹ä»¶æ•°ç»„çš„é›†åˆä¸­è¿½åŠ å›è°ƒå‡½æ•°ã€‚

## è§¦å‘

- `this.$emit('eventName', params)`

ä¸Šä¸€æ­¥æåˆ°ï¼Œ`$emit` çš„æ—¶å€™ï¼Œç›¸åº”æ³¨å†Œçš„äº‹ä»¶éƒ½ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œè€Œä¸” `on` æ³¨å†Œçš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥å…¶å®ç°åº”è¯¥æ˜¯éå† `emit` äº‹ä»¶æ‰€å¯¹åº”çš„æ•°ç»„ï¼Œä¾æ¬¡æ‰§è¡Œ `callback` å¹¶ä¸”å°†å‚æ•°ä¼ é€’å‡ºå»ã€‚

## è§¦å‘ä¸€æ¬¡

- `this.$once('eventName', (...params) => {})`
  
è§¦å‘ä¸€æ¬¡ï¼Œå®ƒçš„å®ç°åº”è¯¥æ˜¯æ— éœ€åˆ¤æ–­ä¹‹å‰äº‹ä»¶æœ‰æ²¡æœ‰æ³¨å†Œï¼Œè¦æ˜¯æ³¨å†Œç›´æ¥æ”¾è¿›å»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ³¨å†Œç›¸åŒçš„äº‹ä»¶åè€…ä¼šè¦†ç›–æ‰å‰è€…ï¼Œæ³¨å†Œæ–°çš„ä¼šå¢åŠ ã€‚

## ç§»é™¤

- `this.$off('eventName)`

`off` ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ç›´æ¥ç”¨å¯¹è±¡ä¸Šåˆ æ‰å½“å‰çš„äº‹ä»¶ã€‚

åœ¨ `vue2.0` çš„ `SFC` ä¸­ï¼Œ`this` æŒ‡å‘æ˜¯ `new Vue()`çš„å®ä¾‹ `vm`ï¼Œå› ä¸ºå…¶ä¸Šå®ä¾‹ä¸Šå·²ç»å…·æœ‰ `eventBus` çš„æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ã€‚

ä¼ªä»£ç ï¼š

```js
let EventBus = {
  taskMap: {},
  $on(eventName, fn) {
    // å¦‚æœmapä¸­æ— æ³¨å†Œäº‹ä»¶ï¼Œåˆ™å°†äº‹ä»¶æ¨å…¥ï¼Œå¦‚æœæœ‰æ³¨å†Œçš„äº‹ä»¶ï¼Œç»§ç»­å¾€é‡Œè¿½åŠ 
    if (!this.taskMap[eventName]) {
      this.taskMap[eventName] = [fn]
    } else {
      this.taskMap[eventName].push(fn)
    }
  },
  $emit(eventName, ...msg) {
    if (!this.taskMap[eventName]) {
      return
    } else {
    //   éå†æ³¨å†Œè¿‡çš„äº‹ä»¶ï¼Œä¾æ¬¡æ‰§è¡Œ
      this.taskMap[eventName].forEach(callback => callback(...msg))
    }
  },
  $once(eventName, fn) {
    // ä¸éœ€è¦åˆ¤æ–­ï¼Œåæ¥çš„è¦†ç›–å‰è¾¹çš„
    this.taskMap[eventName] = [fn]
  },
  $off(eventName) {
    if (!this.taskMap[eventName]) {
      return
    } else {
    //   åˆ æ‰æ³¨å†Œçš„äº‹ä»¶
      Reflect.deleteProperty(this.taskMap, [eventName])
    }
  }
}
```

ä½¿ç”¨

```js

// æ³¨å†Œ
EventBus.$on("begin", (...x) => {
  console.log(...x);
});

EventBus.$off("begin");

EventBus.$emit("begin", "å‚æ•°1000000", "å‚æ•°2"); // ä¸ä¼šè§¦å‘

EventBus.$once("begin", (...x) => {
  console.log(x);
});
EventBus.$emit("begin", "ğŸ…", "ğŸ‰"); // è§¦å‘ä¸€æ¬¡once ["ğŸ…", "ğŸ‰"]
EventBus.$off("begin");

EventBus.$on("begin", (...x) => {
  console.log(...x, "1");
});
EventBus.$on("begin", (...x) => {
  console.log(...x, "2");
});
EventBus.$emit("begin", "ğŸƒâ€â™€ï¸", "ğŸš¢"); // è§¦å‘2æ¬¡on ğŸƒâ€â™€ï¸ï¼ŒğŸš¢ï¼Œ1  ğŸƒâ€â™€ï¸ï¼ŒğŸš¢ï¼Œ2
```
